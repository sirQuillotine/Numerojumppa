<!DOCTYPE html>
<html>
  <head>
    <style></style>
  </head>
  <body>
    <script>
      //redefine the method
      Math.pow_ = Math.pow;
      Math.pow = function (_base, _exponent) {
        if (_base < 0) {
          if (Math.abs(_exponent) < 1) {
            //we're calculating nth root of _base, where n === 1/_exponent
            if ((1 / _exponent) % 2 === 0) {
              //nth root of a negative number is imaginary when n is even, we could return
              //a string like "123i" but this would completely mess up further computation
              return NaN;
            } /*else if (1 / _exponent % 2 !== 0)*/
            //nth root of a negative number when n is odd
            return -Math.pow_(Math.abs(_base), _exponent);
          }
        } /*else if (_base >=0)*/
        //run the original method, nothing will go wrong
        return Math.pow_(_base, _exponent);
      };

      Math.sin_ = Math.sin;
      Math.sin = function (x) {
        if (x % Math.PI == 0) {
          return 0;
        } else {
          return Math.sin_(x);
        }
      };

      Math.cos_ = Math.cos;
      Math.cos = function (x) {
        if (x % (Math.PI / 2) == 0) {
          return 0;
        } else {
          return Math.cos_(x);
        }
      };

      Math.tan_ = Math.tan;
      Math.tan = function (x) {
        if (x % Math.PI == 0) {
          return 0;
        } else {
          return Math.tan_(x);
        }
      };
    </script>
    <link rel="stylesheet" href="leevintyyli.css" />
    <link rel="stylesheet" href="mathquill\mathquill-0.10.1\mathquill.css" />
    <script src="evaluatex\dist\evaluatex.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="mathquill\mathquill-0.10.1\mathquill.js"></script>
    <script>
      var MQ = MathQuill.getInterface(2);
    </script>

    <script src="Järjestelmäarvot.js"></script>

    <div id="main-container">
      <div id="top-container">
        <div id="print-field"></div>

        <div class="side-bar" id="books-bar">Ohjeet ja kirjat</div>

        <div class="side-bar" id="settings-bar">Asetukset</div>
      </div>
      <p id="error"></p>
      <div id="bottom-container">
        <p id="syöte"><span id="answer"></span></p>

        <div
          onclick="ShowBooksBar()"
          class="bottom-bar-button"
          id="book-button"
        >
          <img src="./book-solid.svg" />
        </div>

        <div
          onclick="ShowSettingsBar()"
          class="bottom-bar-button"
          id="settings-button"
        >
          <img src="./gear-solid.svg" />
        </div>
      </div>
    </div>

    <script>
      value = localStorage.getItem("teema");
      if (value == null) {
        value = "vaaleateema";
      }
      ToggleTeema(value);
      var nykyinenTeema = value;

      _vakiot = JSON.parse(localStorage.getItem("vakiot"));
      _funktiot = JSON.parse(localStorage.getItem("funktiot"));

      if (_vakiot == null) {
        _vakiot = vakiot;
      }
      if (_funktiot == null) {
        _funktiot = funktiot;
      }

      var vakiokirjaData = {};
      var funktiokirjaData = funktioData;

      var tieteellinen = localStorage.getItem("tieteellinen");

      if (tieteellinen == null || tieteellinen == "false") {
        tieteellinen = false;
        //yleinen = document.getElementById("yleinen");
        //yleinen.innerText = "⚬ Yleinen";
      } else {
        tieteellinen = true;
        //tiede = document.getElementById("tieteellinen");
        //tiede.innerText = "⚬ Tieteellinen";
      }

      var tarkkuuss = localStorage.getItem("tarkkuus");
      merkitsevät = false;
      if (tarkkuuss == null) {
        //.getElementById("tavallinen").innerText = "⚬ Tavallinen";
        tarkkuus = 15;
      } else {
        switch (tarkkuuss.split(":")[0]) {
          case "tavallinen":
            //document.getElementById("tavallinen").innerText = "⚬ Tavallinen";
            tarkkuus = 15;
            break;

          case "desimaali":
            //document.getElementById("desimaali").innerText =
            "⚬ " + tarkkuuss.split(":")[1] + " desimaalia";
            tarkkuus = parseInt(tarkkuuss.split(":")[1]);
            break;

          case "merkitsevä":
            merkitsevät = true;
            //document.getElementById("merkitsevä").innerText =
            "⚬ " + tarkkuuss.split(":")[1] + " merkitsevää numeroa";
            tarkkuus = parseInt(tarkkuuss.split(":")[1]);
            break;
        }
      }

      document.onkeydown = function (e) {
        if (e.key == "Enter") {
          answerMathField.focus();
        }
      };

      var lastans = "";
      var lastPre = "";
      const errorEl = document.getElementById("error");
      //MQ.StaticMath(errorEl);
      //errorEl.latex("1+1");

      var answerSpan = document.getElementById("answer");
      var answerMathField = MQ.MathField(answerSpan, {
        spaceBehavesLikeTab: false,
        restrictMismatchedBrackets: true,
        supSubsRequireOperand: true,
        autoCommands: "pi sqrt nthroot",
        autoOperatorNames: "int",
        handlers: {
          edit: function () {
            var latex = answerMathField.latex();
            if (latex == "") {
              errorEl.innerText = "";
              return null;
            }

            if (latex.includes("=")) {
              errorEl.innerText = "";
              return null;
            }

            try {
              latex = LastParse(latex);
              latex = latex
                .replaceAll("\\pi", "PI")
                .replaceAll("ans", lastans)
                .replaceAll(",", ".")
                .replaceAll(";", ",");

              var a = evaluatex(latex, _funktiot)(_vakiot);

              if (merkitsevät) {
                a = parseFloat(a.toPrecision(tarkkuus));
              } else {
                var power = Math.pow(10, tarkkuus || 0);
                a = (Math.round(a * power) / power).toFixed(tarkkuus);
              }
              a = parseFloat(a).toExponential(tarkkuus);

              if (tarkkuus == 15) {
                a = parseFloat(a);
              }

              if (!isNaN(a) && isFinite(a)) {
                a = a.toString().replaceAll(".", ",");
                errorEl.innerText = "= " + a;
                lastPre = a;
              } else {
                errorEl.innerText = "NaN";
              }
            } catch (err) {
              errorEl.innerText = "Käänösvirhe";
            }
          },
          enter: function () {
            var latex = answerMathField.latex();
            var olatex = latex;

            if (latex == "") {
              return null;
            }
            // Create element:
            const ans = document.createElement("p");
            ans.setAttribute("class", "vastaus");
            const eq = document.createElement("p");

            if (latex.includes("=")) {
              try {
                LisääFunktioTaiMuuttuja(latex, olatex);
                return null;
              } catch (error) {
                return null;
              }
            }

            latex = LastParse(latex);

            latex = latex
              .replaceAll("\\pi", "PI")
              .replaceAll("ans", lastans)
              .replaceAll(",", ".")
              .replaceAll(";", ",");

            try {
              var a = evaluatex(latex, _funktiot)(_vakiot);
              console.log("Aito  " + a);
              var el = document.createElement("textarea");

              if (merkitsevät) {
                a = parseFloat(a.toPrecision(tarkkuus));
              } else if (tarkkuus != 15) {
                var power = Math.pow(10, tarkkuus || 0);
                a = (Math.round(a * power) / power).toFixed(tarkkuus);
              }

              if (tieteellinen) {
                if (tarkkuus == 15) {
                  a = parseFloat(a).toExponential();
                } else {
                  if (merkitsevät) {
                    a = parseFloat(a).toExponential(tarkkuus - 1);
                  } else {
                    a = parseFloat(a).toExponential(tarkkuus);
                  }
                }
              }

              if (!isNaN(a) && isFinite(a)) {
                a = a.toString().replaceAll(".", ",");
                if (a.indexOf("e+") >= 0) {
                  var i = a.indexOf("e+");
                  b = a.substring(i + 2);

                  c = a.substring(0, i) + "\\cdot10^{" + b + "}";

                  lastans = c;
                  ans.innerText = "= " + c;
                  el.innerText = c;
                } else if (a.indexOf("e-") >= 0) {
                  console.log(a.indexOf("e-"));
                  var i = a.indexOf("e-");
                  b = a.substring(i + 2);

                  c = a.substring(0, i) + "\\cdot10^{-" + b + "}";

                  lastans = c;
                  ans.innerText = "= " + c;
                  el.innerText = c;
                } else {
                  lastans = a;
                  ans.innerText = "= " + a;
                  el.innerText = a;
                }
                MQ.StaticMath(ans);
                ans.setAttribute("ondblclick", "annaVastaus(this)");

                el.setAttribute("readonly", "");
                document.body.appendChild(el);
                el.select();
                document.execCommand("copy");
                document.body.removeChild(el);

                var main = document.getElementById("print-field");

                var node = document.createElement("div");
                node.setAttribute("id", "tuloste");
                main.appendChild(node);
                // Append to body:

                var div1 = document.createElement("div");
                var div2 = document.createElement("div");

                node.append(div1);
                node.append(div2);

                eq.innerText = olatex;
                div1.appendChild(eq);
                MQ.StaticMath(eq);
                div2.appendChild(ans);
                eq.setAttribute("ondblclick", "annaLasku(this)");

                main.scrollTo(0, main.scrollHeight);
                answerMathField.latex("");
              } else {
                errorEl.innerText = "NaN";
              }
            } catch (err) {
              console.log(err);
              console.log("Seks");
              errorEl.innerText = "Käännösvirhe";
            }
            answerMathField.focus();
          },
        },
      });

      function annaVastaus(el) {
        t = MQ(el).latex().replace("=", "");
        answerMathField.write(t);
        answerMathField.focus();
      }
      function annaLasku(el) {
        t = MQ(el).latex();
        answerMathField.write(t);
        answerMathField.focus();
      }
      function annaVakio(el) {
        t = MQ(el).latex().split("=")[0];
        answerMathField.write(t);
        answerMathField.focus();
      }
      function annaFunktio(el) {
        console.log(MQ(el).latex());
        t = MQ(el).latex().split("=")[0];
        answerMathField.write(t);
        answerMathField.focus();
      }

      function ToggleBar(uusi) {
        if (aukinainenkirja == uusi) {
          bar.style.width = "40px";
          uusi.style.display = "none";
          aukinainenkirja = null;
        } else {
          if (aukinainenkirja == null) {
            uusi.style.display = "block";
            bar.style.width = "350px";
            aukinainenkirja = uusi;
          } else {
            aukinainenkirja.style.display = "none";
            uusi.style.display = "block";
            bar.style.width = "350px";
            aukinainenkirja = uusi;
          }
        }
      }

      /*
      for (const [key, value] of Object.entries(_vakiot)) {
        vakiokirjaData[key] = key + "=" + value;
      }
      PäivitäVakiokirja();

      PäivitäFunktiokirja();
      */
      function LisääFunktioTaiMuuttuja(latex, olatex) {
        //Sisältää funktion tai vakion julistuksen
        const eq = document.createElement("p");

        var julistus = latex.split("=")[0];
        nimi = julistus.split("\\")[0];

        if (julistus.includes("(") && julistus.includes(")")) {
          parametrit = julistus.substring(julistus.indexOf("(") + 1);
          parametrit = parametrit.substring(0, parametrit.indexOf(")") - 6);

          var args = parametrit.split(",");
          for (let arg of args) {
            if (!/^[a-zA-Z]+$/.test(arg)) {
              errorEl.innerText = "Funktion muuttuja ei voi olla numero";
              return null;
            }
            if (!latex.split("=")[1].includes(arg)) {
              errorEl.innerText =
                "Funktion lauseke ei sisällä kaikkia muuttujia";
              return null;
            }
          }
          var f = function (args) {
            var dict = _vakiot;
            for (var i = 0; i < arguments.length; i++) {
              dict[parametrit.split(",")[i]] = arguments[i];
            }
            var a = latex.split("=")[1];
            a = LastParse(a);
            a = a
              .replaceAll("\\pi", "PI")
              .replaceAll("ans", lastans)
              .replaceAll(",", ".")
              .replaceAll(";", ",");
            console.log(a);
            return evaluatex(a, _funktiot)(dict);
          };

          try {
            var testi = f(1);
          } catch (error) {
            console.log(error);
            errorEl.innerText = "Funktio ei ole kelpoinen";
            return null;
          }

          _funktiot[nimi] = f;
          //Lisää funktio
          funktiokirjaData[nimi] =
            nimi + "(" + parametrit + ")=" + latex.split("=")[1];
          PäivitäFunktiokirja();
          //Tallenna funktio
          localStorage.setItem("funktiot", JSON.stringify(_funktiot));
          //Vastauksen käsittely
          var main = document.getElementById("tulosteet");
          var node = document.createElement("div");
          node.setAttribute("id", "tuloste");
          main.appendChild(node);
          // Append to body:
          eq.innerText = olatex;
          node.appendChild(eq);
          MQ.StaticMath(eq);

          main.scrollTo(0, main.scrollHeight);
          answerMathField.latex("");
          return null;
        } else if (!/\d/.test(julistus.split("_")[0])) {
          //Tallenna vakio
          vakiokirjaData[nimi] = nimi + "=" + latex.split("=")[1];
          latex = latex
            .replaceAll("\\pi", "PI")
            .replaceAll("ans", lastans)
            .replaceAll(",", ".")
            .replaceAll(";", ",");
          _vakiot[nimi] = evaluatex(latex.split("=")[1], _funktiot)(_vakiot);

          PäivitäVakiokirja();
          localStorage.setItem("vakiot", JSON.stringify(_vakiot));
          var main = document.getElementById("tulosteet");

          var node = document.createElement("div");
          node.setAttribute("id", "tuloste");
          main.appendChild(node);
          // Append to body:
          eq.innerText = olatex;
          node.appendChild(eq);
          MQ.StaticMath(eq);

          main.scrollTo(0, main.scrollHeight);
          answerMathField.latex("");
          return null;
        }

        errorEl.innerText = "Vakion nimi ei voi sisältää numeroita";
      }

      function PäivitäFunktiokirja() {
        for (const [key, value] of Object.entries(funktiokirjaData)) {
          const vanha = document.getElementById(key);
          if (vanha != null) {
            if (vanha.className == "funktiokirja") {
              vanha.remove();
            }
          }

          const elementti = document.createElement("p");
          elementti.setAttribute("ondblclick", "annaFunktio(this)");
          elementti.innerText = value;
          MQ.StaticMath(elementti);

          const astia = document.createElement("div");
          astia.setAttribute("id", key);
          astia.setAttribute("class", "funktiokirja");

          funktiokirja.appendChild(astia);
          astia.appendChild(elementti);
        }
      }

      function PäivitäVakiokirja() {
        for (const [key, value] of Object.entries(vakiokirjaData)) {
          const vanha = document.getElementById(key);
          if (vanha != null) {
            if (vanha.className == "vakiokirja") {
              vanha.remove();
            }
          }
          const elementti = document.createElement("p");
          elementti.setAttribute("ondblclick", "annaVakio(this)");
          var a = value;
          if (a.toString().indexOf("e+") >= 0) {
            var i = a.toString().indexOf("e+");
            b = a.toString().substring(i + 2);

            c = a.toString().substring(0, i) + "\\cdot10^{" + b + "}";

            elementti.innerText = c;
          } else if (a.toString().indexOf("e-") >= 0) {
            var i = a.toString().indexOf("e-");
            b = a.toString().substring(i + 2);

            c = a.toString().substring(0, i) + "\\cdot10^{-" + b + "}";

            elementti.innerText = c;
          } else {
            elementti.innerText = a;
          }
          MQ.StaticMath(elementti);

          const astia = document.createElement("div");
          astia.setAttribute("id", key);
          astia.setAttribute("class", "vakiokirja");

          vakiokirja.appendChild(astia);
          astia.appendChild(elementti);
        }
      }

      function ToggleOhje() {
        ToggleBar("asetukset");
        const palkki = document.getElementById("ohje");
        if (palkki.style.display == "block") {
          palkki.style.display = "none";
        } else {
          palkki.style.display = "block";
        }
      }

      function LastParse(latex) {
        var regex = /sqrt/gi,
          result,
          indices = [];
        while ((result = regex.exec(latex))) {
          var i = result.index;
          var j = i;
          while (latex[j] != "}") {
            j++;
          }
          var terms = latex
            .substring(i + 5, j)
            .replace("{", "")
            .split("]");
          if (terms[1] != null) {
            latex =
              latex.substr(0, i - 1) +
              "rootn(" +
              terms[1] +
              ";" +
              terms[0] +
              ")" +
              latex.substr(j + 1);
          }
        }
        var regex = /log_/gi,
          result,
          indices = [];
        while ((result = regex.exec(latex))) {
          var i = result.index;
          var j = i;
          var base;
          if (latex.charAt(i + 4) == "{") {
            while (latex[j] != "}") {
              j++;
              if (j - i > 50) {
                return null;
              }
            }
            base = latex.substring(i + 5, j);
          } else {
            base = latex.charAt(i + 4);
          }
          var k = j;
          while (latex[k] != "(") {
            k++;
            if (k - i > 50) {
              return null;
            }
          }
          var l = k;
          while (latex[l] != ")") {
            l++;
            if (l - i > 50) {
              return null;
            }
          }
          var x = latex.substring(k + 1, l - 6);
          latex =
            latex.substr(0, i - 1) +
            " (logn(" +
            x +
            ";" +
            base +
            "))" +
            latex.substr(l + 1);
        }

        return latex;
      }

      function ToggleTeema(teema) {
        document.body.classList.add(teema);
        document.body.classList.remove(nykyinenTeema);
        localStorage.setItem("teema", teema);
        nykyinenTeema = teema;
      }

      function ToggleTarkkuus(element) {
        var tavallinen = document.getElementById("tavallinen");
        var desimaali = document.getElementById("desimaali");
        var merkitsevä = document.getElementById("merkitsevä");

        if (element == tavallinen) {
          tarkkuus = 15;
          element.innerText = "⚬ Tavallinen";
          desimaali.innerText = "1 desimaali";
          merkitsevä.innerText = "1 merkitsevä luku";
          localStorage.setItem("tarkkuus", "tavallinen:15");
        }

        if (element == merkitsevä) {
          if (element.innerText.charAt(0) != "⚬") {
            tarkkuus = 1;
            merkitsevät = true;
          } else {
            if (tarkkuus + 1 > 10) {
              tarkkuus = 1;
            } else {
              tarkkuus += 1;
            }
          }

          element.innerText = "⚬ " + tarkkuus + " merkitsevää lukua";
          tavallinen.innerText = "Tavallinen";
          desimaali.innerText = "1 desimaali";
          localStorage.setItem("tarkkuus", "merkitsevä:" + tarkkuus);
        } else {
          merkitsevät = false;
        }

        if (element == desimaali) {
          if (element.innerText.charAt(0) != "⚬") {
            tarkkuus = 1;
          } else {
            if (tarkkuus + 1 > 10) {
              tarkkuus = 1;
            } else {
              tarkkuus += 1;
            }
          }

          element.innerText = "⚬ " + tarkkuus + " desimaalia";
          tavallinen.innerText = "Tavallinen";
          merkitsevä.innerText = "1 merkitsevä luku";
          localStorage.setItem("tarkkuus", "desimaali:" + tarkkuus);
        }
      }

      function ToggleMuoto(element) {
        if (element.innerText.charAt(0) != "⚬") {
          tieteellinen = !tieteellinen;
          localStorage.setItem("tieteellinen", tieteellinen);
        }
        yleinen = document.getElementById("yleinen");
        tiede = document.getElementById("tieteellinen");

        yleinen.innerText = "Yleinen";
        tiede.innerText = "Tieteellinen";

        element.innerText = "⚬ " + element.innerText;

        console.log(tieteellinen);
      }

      function ShowSettingsBar() {
        var x = document.getElementById("settings-bar");
        var y = document.getElementById("books-bar");

        console.log(x.style.display);

        if (x.style.display === "none" || x.style.display == "") {
          y.style.display = "none";
          x.style.display = "block";
        } else {
          y.style.display = "none";
          x.style.display = "none";
        }
      }

      function ShowBooksBar() {
        var x = document.getElementById("settings-bar");
        var y = document.getElementById("books-bar");

        if (y.style.display === "none" || y.style.display == "") {
          x.style.display = "none";
          y.style.display = "block";
        } else {
          y.style.display = "none";
          x.style.display = "none";
        }
      }
    </script>
  </body>
</html>
